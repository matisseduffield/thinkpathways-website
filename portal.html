<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pathway Portal - Think Pathways</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%230ea5e9%22/></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- 1. Load React & ReactDOM as Globals (More reliable for standalone files) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 2. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' },
                        accent: { 500: '#10b981' }
                    }
                }
            }
        }
        
        // --- CONFIGURATION SECTION ---
        // PASTE YOUR FIREBASE CONFIG BELOW INSIDE THE QUOTES
        window.__firebase_config = {
             apiKey: "AIzaSyDO315mAW8JphkSPqcp8Z9VPakBIUlCrl8", 
             authDomain: "thinkpathways.firebaseapp.com", 
             projectId: "thinkpathways", 
             storageBucket: "thinkpathways.firebasestorage.app", 
             messagingSenderId: "31616186160", 
             appId: "1:31616186160:web:646c33b844b999e81efaf5"
        };
    </script>
    
    <style>
        #error-display { display: none; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
    
    <!-- Error Catching UI -->
    <div id="error-display" class="fixed inset-0 bg-white z-50 flex items-center justify-center p-8">
        <div class="max-w-lg w-full bg-red-50 border border-red-200 p-6 rounded-xl">
            <h2 class="text-xl font-bold text-red-800 mb-2">Portal Error</h2>
            <p class="text-red-600 mb-4">Something went wrong loading the portal.</p>
            <pre id="error-message" class="bg-white p-4 rounded border border-red-100 text-xs overflow-auto font-mono text-red-500"></pre>
            <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reload Page</button>
        </div>
    </div>

    <div id="root"></div>

    <!-- 3. The React Application -->
    <script type="text/babel" data-type="module">
        // Error Handler
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-display').style.display = 'flex';
            document.getElementById('error-message').textContent = `${message}\n\nLine: ${lineno}`;
        };

        // Use React from window globals
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;

        // Import Firebase Modules directly from Google's CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged, 
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Safe Init
        let app, auth, db;
        let configMissing = false;

        try {
             const config = window.__firebase_config;
             if (!config.apiKey || config.apiKey === "") {
                 configMissing = true;
             } else {
                 app = initializeApp(config);
                 auth = getAuth(app);
                 db = getFirestore(app);
             }
        } catch (e) {
            console.error("Firebase setup failed", e);
            configMissing = true;
        }

        const AuthContext = React.createContext();

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            // Handle both Firestore timestamp objects and standard dates
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
        };

        const getTomorrowDate = () => {
            const d = new Date();
            d.setDate(d.getDate() + 1);
            return d.toISOString().split('T')[0];
        };

        // --- Custom Hook ---
        const useAuthAndData = () => {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [shifts, setShifts] = useState([]);
            const [isLoadingShifts, setIsLoadingShifts] = useState(false);

            useEffect(() => {
                if (configMissing || !auth) {
                    setIsAuthReady(true);
                    return;
                }
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) {
                    setShifts([]);
                    return;
                }
                
                const path = `users/${user.uid}/shifts`;
                const q = query(collection(db, path));
                setIsLoadingShifts(true);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => {
                        const d = doc.data();
                        let statusText = d.status;
                        if (d.status === 'Pending') statusText = 'Request Sent';
                        if (d.status === 'Confirmed') statusText = 'Scheduled';
                        if (d.status === 'Cancelled') statusText = 'Unavailable';

                        return {
                            id: doc.id,
                            ...d,
                            status: statusText,
                            dateDisplay: d.date || 'Pending', 
                        };
                    });
                    data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setShifts(data);
                    setIsLoadingShifts(false);
                });
                return () => unsubscribe();
            }, [user]);

            const login = (email, password) => signInWithEmailAndPassword(auth, email, password);
            const signup = async (email, password, name) => {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(cred.user, { displayName: name });
            };
            const logout = () => signOut(auth);
            
            const bookShift = async (data) => {
                if (!user || !db) return false;
                try {
                    await addDoc(collection(db, `users/${user.uid}/shifts`), {
                        ...data,
                        userId: user.uid,
                        status: 'Pending',
                        timestamp: serverTimestamp(),
                    });
                    return true;
                } catch (e) {
                    console.error(e);
                    return false;
                }
            };

            return { user, isAuthReady, shifts, isLoadingShifts, login, signup, logout, bookShift };
        };

        // --- Config Warning Component ---
        const ConfigWarning = () => (
            <div className="min-h-screen flex items-center justify-center p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md text-center border-l-4 border-yellow-400">
                    <div className="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                        <i className="fa-solid fa-wrench"></i>
                    </div>
                    <h2 className="text-2xl font-bold text-slate-900 mb-2">Setup Required</h2>
                    <p className="text-slate-600 mb-6">
                        The portal needs your Firebase configuration to work. Open <code>portal.html</code> on your computer and paste your API keys in the config section at the top.
                    </p>
                    <a href="index.html" className="text-brand-600 font-bold hover:underline">Return to Home</a>
                </div>
            </div>
        );

        // --- Login Component ---
        const Login = () => {
            const { login, signup } = React.useContext(AuthContext);
            const [isSignup, setIsSignup] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                const data = new FormData(e.target);
                
                try {
                    if (isSignup) {
                        await signup(data.get('email'), data.get('password'), data.get('name'));
                    } else {
                        await login(data.get('email'), data.get('password'));
                    }
                } catch (err) {
                    setError(err.message.replace('Firebase: ', ''));
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-brand-600 rounded-2xl flex items-center justify-center text-white text-3xl mx-auto mb-4 shadow-lg">
                                <i className="fa-solid fa-hands-holding-circle"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-900">My Pathway Portal</h1>
                            <p className="text-slate-500 text-sm mt-2">
                                {isSignup ? 'Create an account to manage your support.' : 'Sign in to view shifts and book sessions.'}
                            </p>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 flex items-center">
                                <i className="fa-solid fa-circle-exclamation mr-2"></i> {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-5">
                            {isSignup && (
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                                    <input name="name" type="text" required className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                                <input name="email" type="email" required className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <input name="password" type="password" required className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" />
                            </div>

                            <button disabled={loading} className="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition-all shadow-md disabled:opacity-50">
                                {loading ? 'Processing...' : (isSignup ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>

                        <div className="mt-6 text-center pt-6 border-t border-slate-100">
                            <button onClick={() => setIsSignup(!isSignup)} className="text-sm text-brand-600 hover:text-brand-800 font-medium">
                                {isSignup ? 'Already have an account? Sign In' : 'New client? Create an account'}
                            </button>
                        </div>
                        <div className="mt-4 text-center">
                             <a href="index.html" className="text-xs text-slate-400 hover:text-slate-600">← Back to Home</a>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Dashboard Components ---
        const BookingForm = () => {
            const { bookShift } = React.useContext(AuthContext);
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMsg(null);
                const d = new FormData(e.target);
                
                if (!d.get('date') || !d.get('service')) {
                    setMsg({ type: 'error', text: 'Please select a date and service.' });
                    setLoading(false);
                    return;
                }
                
                // Simple date check
                const selectedDate = new Date(d.get('date'));
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate());
                if(selectedDate < tomorrow) {
                     setMsg({ type: 'error', text: 'Please select a date tomorrow or later.' });
                     setLoading(false);
                     return;
                }

                const success = await bookShift({
                    date: d.get('date'),
                    duration: d.get('duration'),
                    service: d.get('service'),
                    notes: d.get('notes')
                });
                
                if (success) {
                    setMsg({ type: 'success', text: 'Request sent successfully!' });
                    e.target.reset();
                } else {
                    setMsg({ type: 'error', text: 'Failed to send request.' });
                }
                setLoading(false);
            };

            return (
                <div className="bg-white p-6 rounded-2xl shadow-md border border-slate-200 sticky top-6">
                    <h3 className="text-xl font-bold text-slate-900 mb-4 flex items-center">
                        <i className="fa-solid fa-calendar-plus text-brand-500 mr-2"></i> Request Session
                    </h3>
                    {msg && <div className={`p-3 mb-4 text-sm rounded-lg border ${msg.type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200'}`}>{msg.text}</div>}
                    <form onSubmit={handleSubmit} className="space-y-5">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                            <input type="date" name="date" required min={getTomorrowDate()} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Duration</label>
                                <select name="duration" className="w-full p-2.5 border border-slate-300 rounded-lg outline-none focus:ring-brand-500">
                                    {[2,3,4,5,6,7,8].map(n => <option key={n} value={n}>{n} Hours</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Service</label>
                                <select name="service" required defaultValue="" className="w-full p-2.5 border border-slate-300 rounded-lg outline-none focus:ring-brand-500">
                                    <option value="" disabled>Select...</option>
                                    <option>Community Access</option>
                                    <option>In-Home Support</option>
                                    <option>Skill Building</option>
                                    <option>Complex Care</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Notes</label>
                            <textarea name="notes" rows="2" className="w-full p-2.5 border border-slate-300 rounded-lg outline-none focus:ring-brand-500" placeholder="Any specific goals?"></textarea>
                        </div>
                        <button disabled={loading} className="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition-all shadow-sm disabled:opacity-70">
                            {loading ? 'Sending...' : 'Request Booking'}
                        </button>
                    </form>
                </div>
            );
        };

        const ShiftList = () => {
            const { shifts, isLoadingShifts } = React.useContext(AuthContext);

            if (isLoadingShifts) return <div className="p-12 text-center text-slate-400 flex flex-col items-center"><i className="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i>Loading history...</div>;
            if (shifts.length === 0) return (
                <div className="p-12 text-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">
                    <i className="fa-regular fa-calendar-xmark text-4xl text-slate-300 mb-3"></i>
                    <p className="text-slate-500 font-medium">No shifts found.</p>
                    <p className="text-xs text-slate-400 mt-1">Use the form to request your first session!</p>
                </div>
            );

            return (
                <div className="space-y-4">
                    {shifts.map(s => (
                        <div key={s.id} className="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center hover:border-brand-200 transition-all hover:shadow-md">
                            <div className="mb-3 md:mb-0">
                                <div className="font-bold text-slate-800 text-lg flex items-center">
                                    <i className="fa-regular fa-calendar text-brand-400 mr-3"></i> {s.dateDisplay}
                                </div>
                                <div className="text-sm text-slate-500 ml-7">{s.service} • {s.duration} hrs</div>
                            </div>
                            <span className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide border ${
                                s.status === 'Scheduled' ? 'bg-green-50 text-green-700 border-green-200' : 
                                s.status === 'Unavailable' ? 'bg-red-50 text-red-700 border-red-200' : 
                                'bg-yellow-50 text-yellow-800 border-yellow-200'
                            }`}>
                                {s.status}
                            </span>
                        </div>
                    ))}
                </div>
            );
        };

        const Dashboard = () => {
            const { user, logout } = React.useContext(AuthContext);
            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-12">
                    <header className="bg-white shadow-sm sticky top-0 z-20 border-b border-slate-200">
                        <div className="max-w-6xl mx-auto p-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white shadow-sm">
                                    <i className="fa-solid fa-hands-holding-circle"></i>
                                </div>
                                <h1 className="text-xl font-bold text-slate-900 tracking-tight hidden md:inline">
                                    My Pathway Portal
                                </h1>
                            </div>
                            <div className="flex items-center gap-6">
                                <span className="text-sm text-slate-500 hidden md:inline">
                                    Welcome, <span className="text-slate-900 font-semibold">{user.displayName || 'Client'}</span>
                                </span>
                                <button onClick={logout} className="text-sm text-red-600 font-bold hover:text-red-800 flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors">
                                    <i className="fa-solid fa-sign-out-alt"></i> Sign Out
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1 order-2 lg:order-1">
                            <BookingForm />
                            <div className="mt-6 bg-blue-50 p-5 rounded-xl border border-blue-100 shadow-sm">
                                <h4 className="font-bold text-blue-900 text-sm mb-2 flex items-center"><i className="fa-solid fa-headset mr-2"></i>Need Help?</h4>
                                <p className="text-xs text-blue-700 leading-relaxed">
                                    For urgent changes or cancellations within 24 hours, please call us directly on <span className="font-mono font-bold text-blue-900 block mt-1 text-base">+61 420 673 303</span>
                                </p>
                            </div>
                        </div>
                        <div className="lg:col-span-2 order-1 lg:order-2">
                            <div className="flex items-center justify-between mb-6 border-b border-slate-200 pb-4">
                                <h2 className="text-2xl font-bold text-slate-900">Your Schedule</h2>
                                <button onClick={() => window.location.reload()} className="text-slate-400 hover:text-brand-600 transition-colors"><i className="fa-solid fa-rotate-right"></i></button>
                            </div>
                            <ShiftList />
                        </div>
                    </main>
                </div>
            );
        };

        const App = () => {
            if (configMissing) return <ConfigWarning />;
            
            const authData = useAuthAndData();
            if (!authData.isAuthReady) return (
                <div className="flex h-screen items-center justify-center bg-slate-100">
                    <i className="fa-solid fa-circle-notch fa-spin text-4xl text-brand-600"></i>
                </div>
            );

            return (
                <AuthContext.Provider value={authData}>
                    {authData.user ? <Dashboard /> : <Login />}
                </AuthContext.Provider>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>